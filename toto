#!/usr/bin/env python3
import csv
import shutil
import re
from pathlib import Path

# ============================
# CONFIG (AUCUN ARGUMENT)
# ============================
BASE_DIR = Path(__file__).parent.resolve()

# 1) Si tu mets ton .7z ici, le script l'extrait automatiquement
#    (ex: majeur529_....7z)
ARCHIVE_7Z = next(iter(BASE_DIR.glob("*.7z")), None)

# 2) Si pas de .7z, il lit le dossier logs/ (si pr√©sent)
LOGS_DIR = BASE_DIR / "logs"

# 3) Dossier d'extraction auto du .7z
EXTRACT_DIR = BASE_DIR / "logs_extracted"

# 4) Sortie (UN SEUL CSV avec doublons)
OUTPUT_CSV = BASE_DIR / "hls_all.csv"

# ============================
# REGEX ADAPT√â √Ä TES LOGS
# ============================
# Matche :
# - HLS00372942
# m√™me si entour√© de '_' ou coll√© √† d'autres caract√®res non-chiffres :
# - _HLS00372942_
# - ...HLS00372942@...
# On √©vite de prendre 9+ chiffres avec (?!\d)
HLS_REGEX = re.compile(r"(?i)HLS\d{8}(?!\d)")


def extract_7z_if_needed() -> Path:
    """
    Si un .7z est trouv√© √† c√¥t√© du script, on l'extrait dans logs_extracted/
    et on renvoie le dossier √† parser.
    Sinon, on renvoie logs/ (si pr√©sent).
    """
    if ARCHIVE_7Z:
        try:
            import py7zr
        except ImportError:
            print("‚ùå Module py7zr manquant.")
            print("‚û°Ô∏è Installe-le avec : pip install py7zr")
            raise

        # Nettoyage ancien extract
        if EXTRACT_DIR.exists():
            shutil.rmtree(EXTRACT_DIR, ignore_errors=True)
        EXTRACT_DIR.mkdir(parents=True, exist_ok=True)

        # Extraction
        with py7zr.SevenZipFile(ARCHIVE_7Z, mode="r") as z:
            z.extractall(path=EXTRACT_DIR)

        print(f"‚úÖ Archive d√©tect√©e et extraite : {ARCHIVE_7Z.name}")
        return EXTRACT_DIR

    # Pas d'archive => logs/
    if LOGS_DIR.exists() and LOGS_DIR.is_dir():
        print("‚úÖ Pas d'archive .7z d√©tect√©e, lecture du dossier ./logs")
        return LOGS_DIR

    print("‚ùå Aucun .7z trouv√© et dossier ./logs introuvable.")
    print("‚û°Ô∏è Mets soit un .7z √† c√¥t√© du script, soit un dossier logs/ avec tes fichiers.")
    raise SystemExit(1)


def list_all_files(folder: Path):
    return [p for p in folder.rglob("*") if p.is_file()]


def main():
    root = extract_7z_if_needed()
    files = list_all_files(root)

    if not files:
        print(f"‚ùå Aucun fichier trouv√© dans : {root}")
        return

    all_hls = []
    total_lines = 0

    for fp in files:
        try:
            with open(fp, "r", encoding="utf-8", errors="ignore") as f:
                for line in f:
                    total_lines += 1
                    for m in HLS_REGEX.finditer(line):
                        all_hls.append(m.group(0).upper())
        except Exception:
            # Si un fichier n'est pas lisible, on le skip sans planter
            continue

    # ‚úÖ UN SEUL CSV (avec doublons, comme ton LibreOffice)
    with open(OUTPUT_CSV, "w", newline="", encoding="utf-8") as f:
        w = csv.writer(f)
        w.writerow(["HLS"])
        for hls in all_hls:
            w.writerow([hls])

    print("\n================ R√âSULTAT ================")
    print(f"üìÇ Dossier analys√©           : {root}")
    print(f"üìÑ Fichiers analys√©s         : {len(files)}")
    print(f"üìë Lignes lues               : {total_lines}")
    print(f"üî¢ Total HLS (cumul, doublons): {len(all_hls)}")
    print(f"üíæ CSV unique sortie         : {OUTPUT_CSV}")
    print("==========================================\n")


if __name__ == "__main__":
    main()