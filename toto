package com.bnpparibas.dsibddf.ap00420.streamfact.batch.billingspace.synchro.update.writer;

import static org.junit.Assert.assertEquals;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;

import java.util.Arrays;
import java.util.List;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.ArgumentCaptor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.mockito.MockedStatic;
import org.mockito.Mockito;
import org.springframework.batch.item.Chunk;

import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.pojo.SynchroResult;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.loanfolder.model.LoanFolderEntity;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.loanfolder.mapper.LoanFolderMapperToJpa;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.loanfolder.repository.LoanFolderAnswerJpaRepository;

/**
 * Classe de test JUnit4 pour LoanFolderSynchroItemWriter.
 * Compatible Sonar/Jenkins : pas de Jupiter, pas d’AssertJ.
 */
@RunWith(MockitoJUnitRunner.class)
public class LoanFolderSynchroItemWriterTest {

    @Mock
    private LoanFolderAnswerJpaRepository loanFolderAnswerJpaRepository;

    @InjectMocks
    private LoanFolderSynchroItemWriter writer;

    private SynchroResult noSync;
    private SynchroResult withSync;

    @Before
    public void setUp() {
        noSync = Mockito.mock(SynchroResult.class);
        withSync = Mockito.mock(SynchroResult.class);

        // On simule un objet "LoanFolderSynchroResult" non nul pour l'item avec synchronisation
        Object mockSynchroResult = new Object();
        Mockito.when(withSync.getLoanFolderSynchroResult()).thenReturn(mockSynchroResult);
        Mockito.when(noSync.getLoanFolderSynchroResult()).thenReturn(null);
    }

    /** Cas 1 : aucun élément n’a de synchronisation */
    @Test
    public void write_shouldCallSaveAllWithEmptyList_whenNoItemHasSynchronisation() {
        Chunk<SynchroResult> chunk = new Chunk<>(Arrays.asList(noSync, noSync));

        writer.write(chunk);

        ArgumentCaptor<List<LoanFolderEntity>> captor = ArgumentCaptor.forClass((Class) List.class);
        verify(loanFolderAnswerJpaRepository, times(1)).saveAll(captor.capture());

        assertEquals(0, captor.getValue().size());
    }

    /** Cas 2 : un seul élément a une synchronisation */
    @Test
    public void write_shouldMapAndSaveOneEntity_whenOneItemHasSynchronisation() {
        Chunk<SynchroResult> chunk = new Chunk<>(Arrays.asList(noSync, withSync));

        LoanFolderEntity mockEntity = Mockito.mock(LoanFolderEntity.class);

        try (MockedStatic<LoanFolderMapperToJpa> mocked = Mockito.mockStatic(LoanFolderMapperToJpa.class)) {
            mocked.when(() -> LoanFolderMapperToJpa.toJpa(any())).thenReturn(mockEntity);

            writer.write(chunk);

            ArgumentCaptor<List<LoanFolderEntity>> captor = ArgumentCaptor.forClass((Class) List.class);
            verify(loanFolderAnswerJpaRepository, times(1)).saveAll(captor.capture());

            assertEquals(1, captor.getValue().size());
        }
    }
}