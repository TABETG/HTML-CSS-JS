package com.bnpparibas.dsibddf.ap00420.streamfact.batch.replay.sendtransferavrequest.processor;

import com.bnpparibas.dsibddf.ap00420.streamfact.domain.entity.history.model.DocaposteEventHistory;
import com.bnpparibas.dsibddf.ap00420.streamfact.domain.entity.transferAv.TransferAvRequest;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.history.mapper.DocaposteEventHistoryEntityMapperToDomain;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.history.model.DocaposteEventHistoryEntity;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.transferAv.mapper.TransferRequestMapperToDomain;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.transferAv.model.TransferAvRequestEntity;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.transferAv.repository.TransferAvJpaRepository;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockedStatic;
import org.mockito.Mockito;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.batch.item.ItemProcessor;

import java.lang.reflect.Field;
import java.util.Optional;

import static org.junit.Assert.*;
import static org.mockito.Mockito.*;

@RunWith(MockitoJUnitRunner.class)
public class ReplaySendTransferAvRequestItemprocessorTest {

    @Mock
    private TransferAvJpaRepository transferAvJpaRepository;

    @InjectMocks
    private ReplaySendTransferAvRequestItemprocessor processor;

    private DocaposteEventHistoryEntity entity;
    private DocaposteEventHistory history;

    @Before
    public void setUp() throws Exception {
        entity = new DocaposteEventHistoryEntity();
        history = new DocaposteEventHistory();
        Field f = DocaposteEventHistory.class.getDeclaredField("transferAvRequestId");
        f.setAccessible(true);
        f.set(history, "REQ-42");
    }

    @Test
    public void process_should_return_domain_when_repository_finds_entity() throws Exception {
        TransferAvRequestEntity found = new TransferAvRequestEntity();
        TransferAvRequest expected = new TransferAvRequest();

        try (MockedStatic<DocaposteEventHistoryEntityMapperToDomain> mockedHistory =
                     Mockito.mockStatic(DocaposteEventHistoryEntityMapperToDomain.class);
             MockedStatic<TransferRequestMapperToDomain> mockedTransfer =
                     Mockito.mockStatic(TransferRequestMapperToDomain.class)) {

            mockedHistory.when(() -> DocaposteEventHistoryEntityMapperToDomain.toDomain(entity))
                    .thenReturn(history);

            when(transferAvJpaRepository.findByTransferAvRequestId("REQ-42"))
                    .thenReturn(Optional.of(found));

            mockedTransfer.when(() -> TransferRequestMapperToDomain.transferRequestToDomain(found))
                    .thenReturn(expected);

            TransferAvRequest result = processor.process(entity);

            assertNotNull(result);
            assertSame(expected, result);

            mockedHistory.verify(() -> DocaposteEventHistoryEntityMapperToDomain.toDomain(entity), times(1));
            verify(transferAvJpaRepository, times(1)).findByTransferAvRequestId("REQ-42");
            mockedTransfer.verify(() -> TransferRequestMapperToDomain.transferRequestToDomain(found), times(1));
        }
    }

    @Test
    public void process_should_return_null_when_repository_returns_empty() throws Exception {
        try (MockedStatic<DocaposteEventHistoryEntityMapperToDomain> mockedHistory =
                     Mockito.mockStatic(DocaposteEventHistoryEntityMapperToDomain.class)) {

            mockedHistory.when(() -> DocaposteEventHistoryEntityMapperToDomain.toDomain(entity))
                    .thenReturn(history);

            when(transferAvJpaRepository.findByTransferAvRequestId("REQ-42"))
                    .thenReturn(Optional.empty());

            TransferAvRequest result = processor.process(entity);

            assertNull(result);
            verify(transferAvJpaRepository, times(1)).findByTransferAvRequestId("REQ-42");
        }
    }

    @Test
    public void class_contract_and_injection_should_be_valid() throws Exception {
        assertTrue(processor instanceof ItemProcessor);
        assertNotNull(ReplaySendTransferAvRequestItemprocessor.class
                .getAnnotation(org.springframework.stereotype.Component.class));
        Field f = ReplaySendTransferAvRequestItemprocessor.class.getDeclaredField("transferAvJpaRepository");
        f.setAccessible(true);
        assertSame(transferAvJpaRepository, f.get(processor));
    }
}