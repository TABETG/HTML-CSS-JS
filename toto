<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <!-- Parent (root) POM -->
  <groupId>com.bnpparibas.dsibddf.ap00420</groupId>
  <artifactId>stream-fact</artifactId>
  <version>1.1</version>
  <packaging>pom</packaging>
  <name>stream-fact parent POM</name>

  <!-- Modules -->
  <modules>
    <module>stream-fact-domain</module>
    <module>stream-fact-application</module>
    <module>stream-fact-exposition</module>
    <module>stream-fact-infra-sql</module>
    <module>stream-fact-infra-rest-clients</module>
    <module>stream-fact-infra-jms</module>
    <module>stream-fact-batch</module>
    <module>stream-fact-infra-smtp</module>
    <module>stream-fact-infra-soap-clients</module>
    <module>stream-fact-infra-static-filestore</module>
  </modules>

  <properties>
    <!-- Java / encodings -->
    <java.version>17</java.version>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
    <maven.compiler.release>${java.version}</maven.compiler.release>

    <!-- Frameworks (kept for compatibility with the project) -->
    <spring-boot.version>3.1.2</spring-boot.version>
    <spring-cloud.version>2022.0.3</spring-cloud.version>

    <!-- Testing: enforce JUnit 4 only (NO Jupiter/Vintage) -->
    <junit4.version>4.13.2</junit4.version>
    <hamcrest.version>2.2</hamcrest.version>
    <mockito.version>5.12.0</mockito.version>

    <!-- Build plugins versions -->
    <jacoco-maven-plugin.version>0.8.10</jacoco-maven-plugin.version>
    <maven-surefire-plugin.version>3.2.5</maven-surefire-plugin.version>
    <maven-failsafe-plugin.version>3.2.5</maven-failsafe-plugin.version>
    <maven-enforcer-plugin.version>3.5.0</maven-enforcer-plugin.version>
    <sonar-maven-plugin.version>3.10.0.2594</sonar-maven-plugin.version>

    <!-- JaCoCo agent argLine propagated to test plugins -->
    <jacocoArgLine/>
    <surefireArgLine>${jacocoArgLine}</surefireArgLine>
    <failsafeArgLine>${jacocoArgLine}</failsafeArgLine>

    <!-- Sonar settings: use the aggregated XML report to push overall coverage > 50% -->
    <sonar.java.coveragePlugin>jacoco</sonar.java.coveragePlugin>
    <sonar.coverage.jacoco.xmlReportPaths>${project.basedir}/target/site/jacoco-aggregate/jacoco.xml</sonar.coverage.jacoco.xmlReportPaths>
    <sonar.junit.reportPaths>${project.basedir}/target/surefire-reports</sonar.junit.reportPaths>

    <!-- Keep your existing exclusions list here (unchanged) -->
    <sonar.exclusions>
      **/JobConfiguration*.java,
      **/*config.java,
      **/*Config.java,
      **/com/bnpparibas/dsibddf/ap00420/streamfact/exposition/**,
      **/com/bnpparibas/dsibddf/ap00420/streamfact/domain/entity/**,
      **/com/bnpparibas/dsibddf/ap00420/streamfact/infrastructure/rest/**/request/**,
      **/com/bnpparibas/dsibddf/ap00420/streamfact/infrastructure/rest/**/response/**,
      **/com/bnpparibas/dsibddf/ap00420/streamfact/batch/**/reader/*Reader.java
      <!-- (si vous avez une liste plus longue, laissez-la ici telle quelle) -->
    </sonar.exclusions>
  </properties>

  <!-- Dependency management to centralize test deps (JUnit4 only) -->
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>${junit4.version}</version>
        <scope>test</scope>
      </dependency>
      <dependency>
        <groupId>org.hamcrest</groupId>
        <artifactId>hamcrest</artifactId>
        <version>${hamcrest.version}</version>
        <scope>test</scope>
      </dependency>
      <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <version>${mockito.version}</version>
        <scope>test</scope>
      </dependency>
      <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-junit-jupiter</artifactId>
        <version>${mockito.version}</version>
        <scope>test</scope>
        <exclusions>
          <!-- Interdit toute dÃ©pendance Jupiter -->
          <exclusion>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-api</artifactId>
          </exclusion>
          <exclusion>
            <groupId>org.junit.vintage</groupId>
            <artifactId>junit-vintage-engine</artifactId>
          </exclusion>
        </exclusions>
      </dependency>
    </dependencies>
  </dependencyManagement>

  <build>
    <pluginManagement>
      <plugins>

        <!-- Enforce: NO JUnit Jupiter / Vintage anywhere (Jenkins/Sonar compliant) -->
        <plugin>
          <groupId>org.apache.maven.plugins</groupId>
          <artifactId>maven-enforcer-plugin</artifactId>
          <version>${maven-enforcer-plugin.version}</version>
          <executions>
            <execution>
              <id>ban-junit-jupiter</id>
              <goals><goal>enforce</goal></goals>
              <configuration>
                <rules>
                  <bannedDependencies>
                    <excludes>
                      <exclude>org.junit.jupiter:*</exclude>
                      <exclude>org.junit.vintage:*</exclude>
                      <exclude>org.assertj:*</exclude>
                    </excludes>
                    <searchTransitive>true</searchTransitive>
                    <message>Use JUnit 4 (junit:junit) only; no Jupiter/Vintage/AssertJ allowed.</message>
                  </bannedDependencies>
                </rules>
                <fail>true</fail>
              </configuration>
            </execution>
          </executions>
        </plugin>

        <!-- Surefire for unit tests (JUnit 4) -->
        <plugin>
          <groupId>org.apache.maven.plugins</groupId>
          <artifactId>maven-surefire-plugin</artifactId>
          <version>${maven-surefire-plugin.version}</version>
          <configuration>
            <useSystemClassLoader>true</useSystemClassLoader>
            <reuseForks>true</reuseForks>
            <forkCount>1C</forkCount>
            <argLine>${surefireArgLine}</argLine>
            <includes>
              <include>**/*Test.java</include>
              <include>**/*Tests.java</include>
            </includes>
            <excludes>
              <exclude>**/*IT.java</exclude>
              <exclude>**/*ITCase.java</exclude>
            </excludes>
          </configuration>
        </plugin>

        <!-- Failsafe (optional ITs). Still runs under JUnit4 if you have any. -->
        <plugin>
          <groupId>org.apache.maven.plugins</groupId>
          <artifactId>maven-failsafe-plugin</artifactId>
          <version>${maven-failsafe-plugin.version}</version>
          <configuration>
            <argLine>${failsafeArgLine}</argLine>
            <includes>
              <include>**/*IT.java</include>
              <include>**/*ITCase.java</include>
            </includes>
          </configuration>
        </plugin>

        <!-- JaCoCo setup: prepare agent in all modules + aggregate XML report at root -->
        <plugin>
          <groupId>org.jacoco</groupId>
          <artifactId>jacoco-maven-plugin</artifactId>
          <version>${jacoco-maven-plugin.version}</version>
          <executions>
            <!-- Inject JaCoCo agent before tests in every module -->
            <execution>
              <id>prepare-agent</id>
              <phase>initialize</phase>
              <goals><goal>prepare-agent</goal></goals>
              <configuration>
                <propertyName>jacocoArgLine</propertyName>
                <append>true</append>
              </configuration>
            </execution>

            <!-- Generate per-module reports (needed for aggregate) -->
            <execution>
              <id>report</id>
              <phase>verify</phase>
              <goals><goal>report</goal></goals>
            </execution>

            <!-- Root module only: aggregate all submodules + produce jacoco-aggregate/jacoco.xml -->
            <execution>
              <id>report-aggregate</id>
              <phase>verify</phase>
              <goals><goal>report-aggregate</goal></goals>
            </execution>
          </executions>
        </plugin>

        <!-- Sonar scanner (run with: mvn -q -DskipITs sonar:sonar) -->
        <plugin>
          <groupId>org.sonarsource.scanner.maven</groupId>
          <artifactId>sonar-maven-plugin</artifactId>
          <version>${sonar-maven-plugin.version}</version>
        </plugin>

      </plugins>
    </pluginManagement>

    <!-- Apply key plugins at parent so children inherit them -->
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-enforcer-plugin</artifactId>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-failsafe-plugin</artifactId>
      </plugin>
      <plugin>
        <groupId>org.jacoco</groupId>
        <artifactId>jacoco-maven-plugin</artifactId>
      </plugin>
      <plugin>
        <groupId>org.sonarsource.scanner.maven</groupId>
        <artifactId>sonar-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>

  <!-- Force JUnit4 on all modules without bringing Jupiter/Vintage -->
  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>${junit4.version}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.hamcrest</groupId>
      <artifactId>hamcrest</artifactId>
      <version>${hamcrest.version}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.mockito</groupId>
      <artifactId>mockito-core</artifactId>
      <version>${mockito.version}</version>
      <scope>test</scope>
    </dependency>
  </dependencies>

  <!-- (Optionnel) Sonar host can also be provided by Jenkins global config -->
  <!--
  <distributionManagement>...</distributionManagement>
  <profiles>...</profiles>
  -->
</project>
