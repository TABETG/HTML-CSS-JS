package com.bnpparibas.dsibddf.ap00420.streamfact.batch.billingspace.synchro.update.processor;

import com.bnpparibas.bddf.cqrs.command.v2.CommandExecutorV2;
import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.pojo.LoanFolderSynchroAnalysis;
import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.pojo.LoanFolderSynchroResult;
import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.pojo.SynchroResult;
import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.update.SynchroBillingSpaceCommand;
import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.update.SynchroBillingSpaceRequest;
import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.update.SynchroLoanFoldersCommand;
import com.bnpparibas.dsibddf.ap00420.streamfact.application.loanfolder.synchro.update.SynchroLoanFoldersRequest;
import com.bnpparibas.dsibddf.ap00420.streamfact.domain.commons.BillingSpaceStatusEnum;
import com.bnpparibas.dsibddf.ap00420.streamfact.domain.entity.billingspace.model.BillingSpace;
import com.bnpparibas.dsibddf.ap00420.streamfact.domain.entity.history.repository.DocaposteEventHistoryRepository;
import com.bnpparibas.dsibddf.ap00420.streamfact.domain.entity.loanfolder.model.LoanFolder;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.billingspace.mapper.BillingSpaceMapperToDomain;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.billingspace.model.BillingSpaceEntity;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.loanfolder.mapper.LoanFolderMapperToDomain;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.*;
import org.mockito.junit.MockitoJUnitRunner;

import java.util.Collections;

import static org.junit.Assert.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * Test JUnit 4 - 100% coverage BillingSpaceSynchroItemProcessor
 */
@RunWith(MockitoJUnitRunner.class)
public class BillingSpaceSynchroItemProcessorTest {

    @InjectMocks
    private BillingSpaceSynchroItemProcessor processor;

    @Mock
    private CommandExecutorV2 commandExecutor;

    @Mock
    private DocaposteEventHistoryRepository docaposteEventHistoryRepository;

    @Mock
    private BillingSpaceEntity billingSpaceEntity;

    @Mock
    private LoanFolder loanFolder;

    @Mock
    private BillingSpace billingSpace;

    @Mock
    private LoanFolderSynchroResult loanFolderSynchroResult;

    @Mock
    private LoanFolderSynchroAnalysis loanFolderSynchroAnalysis;

    @Before
    public void setUp() {
        when(billingSpaceEntity.getLoanFolder()).thenReturn(mock(com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.loanfolder.model.LoanFolderEntity.class));
    }

    @Test
    public void process_should_return_synchroResult_when_conditions_valid() {
        try (MockedStatic<BillingSpaceMapperToDomain> billingMapper = Mockito.mockStatic(BillingSpaceMapperToDomain.class);
             MockedStatic<LoanFolderMapperToDomain> loanMapper = Mockito.mockStatic(LoanFolderMapperToDomain.class)) {

            billingMapper.when(() -> BillingSpaceMapperToDomain.toDomain(any())).thenReturn(billingSpace);
            loanMapper.when(() -> LoanFolderMapperToDomain.toDomain(any())).thenReturn(loanFolder);

            when(commandExecutor.execute(eq(SynchroLoanFoldersCommand.class), any(SynchroLoanFoldersRequest.class)))
                    .thenReturn(loanFolderSynchroResult);
            when(commandExecutor.execute(eq(SynchroBillingSpaceCommand.class), any(SynchroBillingSpaceRequest.class)))
                    .thenReturn(billingSpace);

            when(loanFolderSynchroResult.getLoanFolder()).thenReturn(loanFolder);
            when(billingSpace.getBillingSpaceStatus()).thenReturn(BillingSpaceStatusEnum.TO_CLOSE);

            LoanFolderSynchroAnalysis analysis = mock(LoanFolderSynchroAnalysis.class);
            when(analysis.getContractLoandFolderAnalysisList()).thenReturn(Collections.singletonList("A"));
            when(loanFolderSynchroResult.getLoanFolderSynchroAnalysis()).thenReturn(analysis);

            SynchroResult result = processor.process(billingSpaceEntity);

            assertNotNull(result);
            assertEquals(billingSpace, result.getBillingSpace());
            assertEquals(loanFolderSynchroResult, result.getLoanFolderSynchroResult());
        }
    }

    @Test
    public void process_should_return_null_when_no_synchro_or_closure() {
        try (MockedStatic<BillingSpaceMapperToDomain> billingMapper = Mockito.mockStatic(BillingSpaceMapperToDomain.class);
             MockedStatic<LoanFolderMapperToDomain> loanMapper = Mockito.mockStatic(LoanFolderMapperToDomain.class)) {

            billingMapper.when(() -> BillingSpaceMapperToDomain.toDomain(any())).thenReturn(billingSpace);
            loanMapper.when(() -> LoanFolderMapperToDomain.toDomain(any())).thenReturn(loanFolder);

            when(commandExecutor.execute(eq(SynchroLoanFoldersCommand.class), any(SynchroLoanFoldersRequest.class)))
                    .thenReturn(loanFolderSynchroResult);
            when(commandExecutor.execute(eq(SynchroBillingSpaceCommand.class), any(SynchroBillingSpaceRequest.class)))
                    .thenReturn(billingSpace);

            LoanFolderSynchroAnalysis analysis = mock(LoanFolderSynchroAnalysis.class);
            when(analysis.getContractLoandFolderAnalysisList()).thenReturn(Collections.emptyList());
            when(analysis.getSynchroAnalysisDatas()).thenReturn(Collections.emptyList());
            when(analysis.getBorrowerLoandFolderAnalysisList()).thenReturn(Collections.emptyList());
            when(analysis.getLoanFolderAnalysisDatas()).thenReturn(Collections.emptyList());
            when(loanFolderSynchroResult.getLoanFolderSynchroAnalysis()).thenReturn(analysis);

            when(billingSpace.getBillingSpaceStatus()).thenReturn(BillingSpaceStatusEnum.ACTIVE);

            SynchroResult result = processor.process(billingSpaceEntity);
            assertNull(result);
        }
    }

    @Test
    public void checkLoanFolderSynchroResultNotEmpty_should_return_non_null_result() {
        LoanFolderSynchroResult input = mock(LoanFolderSynchroResult.class);
        LoanFolderSynchroAnalysis analysis = mock(LoanFolderSynchroAnalysis.class);
        when(analysis.getContractLoandFolderAnalysisList()).thenReturn(Collections.singletonList("X"));
        when(input.getLoanFolderSynchroAnalysis()).thenReturn(analysis);

        LoanFolderSynchroResult result = invokePrivateCheckMethod(input);
        assertNotNull(result);
    }

    @Test
    public void checkLoanFolderSynchroResultNotEmpty_should_return_null_if_all_lists_empty() {
        LoanFolderSynchroResult input = mock(LoanFolderSynchroResult.class);
        LoanFolderSynchroAnalysis analysis = mock(LoanFolderSynchroAnalysis.class);
        when(analysis.getContractLoandFolderAnalysisList()).thenReturn(Collections.emptyList());
        when(analysis.getSynchroAnalysisDatas()).thenReturn(Collections.emptyList());
        when(analysis.getBorrowerLoandFolderAnalysisList()).thenReturn(Collections.emptyList());
        when(analysis.getLoanFolderAnalysisDatas()).thenReturn(Collections.emptyList());
        when(input.getLoanFolderSynchroAnalysis()).thenReturn(analysis);

        LoanFolderSynchroResult result = invokePrivateCheckMethod(input);
        assertNull(result);
    }

    // Helper pour tester méthode privée via réflexion
    private LoanFolderSynchroResult invokePrivateCheckMethod(LoanFolderSynchroResult arg) {
        try {
            java.lang.reflect.Method m = BillingSpaceSynchroItemProcessor.class
                    .getDeclaredMethod("checkLoanFolderSynchroResultNotEmpty", LoanFolderSynchroResult.class);
            m.setAccessible(true);
            return (LoanFolderSynchroResult) m.invoke(processor, arg);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}