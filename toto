#!/usr/bin/env python3
import csv
import shutil
import re
from pathlib import Path

# ============================
# CONFIG (AUCUN ARGUMENT)
# ============================
BASE_DIR = Path(__file__).parent.resolve()

# Si un .7z est prÃ©sent Ã  cÃ´tÃ© du script : extraction automatique
ARCHIVE_7Z = next(iter(BASE_DIR.glob("*.7z")), None)

# Sinon on lit ./logs/
LOGS_DIR = BASE_DIR / "logs"

# Dossier d'extraction auto du .7z
EXTRACT_DIR = BASE_DIR / "logs_extracted"

# âœ… Sortie unique (sans doublons)
OUTPUT_CSV = BASE_DIR / "hls_unique.csv"

# ============================
# REGEX ADAPTÃ‰ Ã€ TES LOGS
# ============================
# Matche : HLS + 8 chiffres, mÃªme entourÃ© de underscores etc.
# Ex: _HLS00371592_  => match HLS00371592
# (?!\d) Ã©vite de capter 9 chiffres ou plus
HLS_REGEX = re.compile(r"(?i)HLS\d{8}(?!\d)")


def extract_7z_if_needed() -> Path:
    """
    Si un .7z est trouvÃ© Ã  cÃ´tÃ© du script, on l'extrait dans logs_extracted/
    et on renvoie le dossier Ã  parser.
    Sinon, on renvoie logs/ (si prÃ©sent).
    """
    if ARCHIVE_7Z:
        try:
            import py7zr
        except ImportError:
            print("âŒ Module py7zr manquant.")
            print("âž¡ï¸ Installe-le avec : pip install py7zr")
            raise

        if EXTRACT_DIR.exists():
            shutil.rmtree(EXTRACT_DIR, ignore_errors=True)
        EXTRACT_DIR.mkdir(parents=True, exist_ok=True)

        with py7zr.SevenZipFile(ARCHIVE_7Z, mode="r") as z:
            z.extractall(path=EXTRACT_DIR)

        print(f"âœ… Archive dÃ©tectÃ©e et extraite : {ARCHIVE_7Z.name}")
        return EXTRACT_DIR

    if LOGS_DIR.exists() and LOGS_DIR.is_dir():
        print("âœ… Pas d'archive .7z dÃ©tectÃ©e, lecture du dossier ./logs")
        return LOGS_DIR

    print("âŒ Aucun .7z trouvÃ© et dossier ./logs introuvable.")
    print("âž¡ï¸ Mets soit un .7z Ã  cÃ´tÃ© du script, soit un dossier logs/ avec tes fichiers.")
    raise SystemExit(1)


def list_all_files(folder: Path):
    return [p for p in folder.rglob("*") if p.is_file()]


def main():
    root = extract_7z_if_needed()
    files = list_all_files(root)

    if not files:
        print(f"âŒ Aucun fichier trouvÃ© dans : {root}")
        return

    unique_hls = set()
    total_lines = 0
    total_occurrences = 0
    files_with_hits = 0

    for fp in files:
        file_hits = 0
        try:
            with open(fp, "r", encoding="utf-8", errors="ignore") as f:
                for line in f:
                    total_lines += 1
                    for m in HLS_REGEX.finditer(line):
                        total_occurrences += 1
                        file_hits += 1
                        unique_hls.add(m.group(0).upper())
        except Exception:
            # Si un fichier n'est pas lisible, on le skip sans planter
            continue

        if file_hits > 0:
            files_with_hits += 1

    # âœ… Export SANS DOUBLONS (triÃ©)
    sorted_unique = sorted(unique_hls)

    with open(OUTPUT_CSV, "w", newline="", encoding="utf-8") as f:
        w = csv.writer(f)
        w.writerow(["HLS"])
        for hls in sorted_unique:
            w.writerow([hls])

    print("\n================ RÃ‰SULTAT ================")
    print(f"ðŸ“‚ Dossier analysÃ©             : {root}")
    print(f"ðŸ“„ Fichiers analysÃ©s           : {len(files)}")
    print(f"ðŸ“„ Fichiers contenant des HLS  : {files_with_hits}")
    print(f"ðŸ“‘ Lignes lues                 : {total_lines}")
    print(f"ðŸ”¢ Occurrences HLS (avec doublons) : {total_occurrences}")
    print(f"âœ… HLS uniques (sans doublons) : {len(unique_hls)}")
    print(f"ðŸ’¾ CSV gÃ©nÃ©rÃ© (unique)         : {OUTPUT_CSV}")
    print("==========================================\n")


if __name__ == "__main__":
    main()