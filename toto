@Test
void write_success_path_shouldSendEvent_callDocaposte_updateHistory_andSave() throws Exception {
    // GIVEN
    BillingSpaceCreationToSend toSend = mock(BillingSpaceCreationToSend.class);

    // Correction : on mocke le bon type de DossierBox
    com.bnpparibas.dsibddf.ap00420.streamfact.domain.repository.docaposte.model.DossierBox dossierBox =
            mock(com.bnpparibas.dsibddf.ap00420.streamfact.domain.repository.docaposte.model.DossierBox.class);
    when(dossierBox.getValue()).thenReturn("DBOX-VALUE");
    when(toSend.getDossierBox()).thenReturn(dossierBox);

    DocaposteEventHistory history = mock(DocaposteEventHistory.class);
    when(toSend.getDocaposteEventHistory()).thenReturn(history);

    DocaposteResponse response = mock(DocaposteResponse.class);
    when(response.getGroupId()).thenReturn("group-123");
    when(docaposteRepository.sendDossierBox(anyList())).thenReturn(Collections.singletonList(response));

    // WHEN
    writer.write(new Chunk<>(Collections.singletonList(toSend)));

    // THEN
    verify(applicationEventMulticaster, times(1)).multicastEvent(any(DPOSaveDataRequestEvent.class));
    verify(docaposteRepository, times(1)).sendDossierBox(anyList());
    verify(docaposteEventHistoryRepository, times(1)).save(any(DocaposteEventHistory.class));
}