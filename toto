#!/usr/bin/env python3
import csv
import re
from pathlib import Path
from typing import Set, Tuple

# ============================
# CONFIGURATION AUTOMATIQUE
# ============================

BASE_DIR = Path(__file__).parent.resolve()
LOGS_DIR = BASE_DIR / "logs"
OUTPUT_CSV = BASE_DIR / "hls_unique.csv"

# Matche :
# - HLS00372942
# - HLS 00372942
# - HLS:00372942
# - HLS_00372942
# - HLS-00372942
HLS_REGEX = re.compile(r"\bHLS\b[\s:_-]*([0-9]{8})\b", re.IGNORECASE)


def extract_hls_from_file(file_path: Path) -> Tuple[Set[str], int, int]:
    """
    Retourne:
      - set des HLS uniques trouvÃ©s dans le fichier
      - nombre total d'occurrences trouvÃ©es
      - nombre de lignes lues
    """
    found: Set[str] = set()
    occurrences = 0
    lines_read = 0

    with open(file_path, "r", encoding="utf-8", errors="ignore") as f:
        for line in f:
            lines_read += 1
            for match in HLS_REGEX.finditer(line):
                occurrences += 1
                found.add("HLS" + match.group(1))

    return found, occurrences, lines_read


def main():
    if not LOGS_DIR.exists() or not LOGS_DIR.is_dir():
        print(f"âŒ Dossier 'logs' introuvable : {LOGS_DIR}")
        print("âž¡ï¸ CrÃ©e un dossier 'logs' et mets-y tes fichiers.")
        return

    all_files = [p for p in LOGS_DIR.rglob("*") if p.is_file()]

    if not all_files:
        print("âŒ Aucun fichier trouvÃ© dans le dossier logs.")
        return

    all_unique_hls: Set[str] = set()
    total_occurrences = 0
    total_lines = 0
    files_with_hls = 0

    for file_path in all_files:
        unique, occ, lines = extract_hls_from_file(file_path)
        total_lines += lines
        total_occurrences += occ

        if occ > 0:
            files_with_hls += 1

        all_unique_hls.update(unique)

    # Tri automatique
    sorted_hls = sorted(all_unique_hls)

    # Ã‰criture CSV
    with open(OUTPUT_CSV, "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["HLS"])
        for hls in sorted_hls:
            writer.writerow([hls])

    print("\n================ RÃ‰SULTAT ================ ")
    print(f"ðŸ“‚ Fichiers analysÃ©s        : {len(all_files)}")
    print(f"ðŸ“„ Fichiers contenant des HLS : {files_with_hls}")
    print(f"ðŸ“‘ Lignes lues               : {total_lines}")
    print(f"ðŸ”Ž Occurrences HLS trouvÃ©es  : {total_occurrences}")
    print(f"âœ… HLS uniques               : {len(all_unique_hls)}")
    print(f"ðŸ’¾ CSV gÃ©nÃ©rÃ©                : {OUTPUT_CSV}")
    print("==========================================\n")


if __name__ == "__main__":
    main()