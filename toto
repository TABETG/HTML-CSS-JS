# ===========================
# Reset Gemini (JetBrains IntelliJ)
# Windows / PowerShell
# ===========================

$ErrorActionPreference = "SilentlyContinue"

# 1) Base JetBrains (adapte si autre version)
$BASE = Join-Path $env:LOCALAPPDATA "JetBrains\IntelliJIdea2025.3"

if (-not (Test-Path $BASE)) {
  Write-Host "ERROR: Dossier introuvable: $BASE"
  Write-Host "➡️ Vérifie la version IntelliJIdeaXXXX.X dans %LOCALAPPDATA%\JetBrains\"
  exit 1
}

Write-Host "BASE = $BASE"

# 2) Stop process JetBrains / LLM/embeddings
$match = @("idea","jetbrains","fsnotifier","embeddings","semantic","kotlin","java")

Get-Process | ForEach-Object {
  foreach ($m in $match) {
    if ($_.Name -like "*$m*") {
      try {
        Stop-Process -Id $_.Id -Force
        Write-Host ("KILLED: {0} (pid={1})" -f $_.Name, $_.Id)
      } catch {}
      break
    }
  }
}

# 3) Targets à supprimer (ciblé Gemini/LLM)
$targets = @(
  "semantic-search",
  "llm-jcp-outbox",
  "junie-jcp-outbox",
  "full-line",
  "global-model-cache"
)

Write-Host "`n--- DELETE TARGETS ---"
foreach ($t in $targets) {
  $p = Join-Path $BASE $t
  if (Test-Path $p) {
    # rmdir Windows (plus robuste contre certains verrous)
    cmd /c "rmdir /s /q `"$p`""
    if (-not (Test-Path $p)) {
      Write-Host "DELETED: $p"
    } else {
      Write-Host "FAILED : $p (encore présent)"
    }
  } else {
    Write-Host "SKIP  : $p"
  }
}

Write-Host "`nDONE."
Write-Host "➡️ Ensuite dans IntelliJ : Settings > Tools > Gemini > API Endpoint Overrides"
Write-Host "   ➜ vide TOUS les champs (laisse vide), Apply, restart, puis Sign out / Sign in."