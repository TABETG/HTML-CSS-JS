package com.bnpparibas.dsibddf.ap00420.streamfact.batch.billingspace.synchro.update.reader;

import com.bnpparibas.dsibddf.ap00420.streamfact.domain.commons.BillingSpaceStatusEnum;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.billingspace.repository.BillingSpaceJpaRepository;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.data.domain.Sort;

import java.lang.reflect.Field;
import java.util.List;
import java.util.Map;

import static org.junit.Assert.*;
import static org.mockito.Mockito.*;

/**
 * JUnit4 - Couverture 100% BillingSpaceSynchroItemReader
 * Compatible Sonar / Jenkins / Jacoco / Java 17+
 */
@RunWith(MockitoJUnitRunner.class)
public class BillingSpaceSynchroItemReaderTest {

    @Mock
    private BillingSpaceJpaRepository repository;

    @InjectMocks
    private BillingSpaceSynchroItemReader reader;

    @Before
    public void init() {
        assertNotNull(reader);
    }

    @Test
    public void init_should_initialize_all_internal_fields() throws Exception {
        reader.init();

        // repository
        Object repoValue = getAnyField(reader, "repository");
        assertSame(repository, repoValue);

        // methodName
        Object methodValue = getAnyField(reader, "methodName");
        assertEquals("findByBillingSpaceStatus", methodValue);

        // arguments
        @SuppressWarnings("unchecked")
        List<Object> args = (List<Object>) getAnyField(reader, "arguments");
        assertEquals(1, args.size());
        assertEquals(BillingSpaceStatusEnum.CREATED, args.get(0));

        // sort
        @SuppressWarnings("unchecked")
        Map<String, Sort.Direction> sortMap = (Map<String, Sort.Direction>) getAnyField(reader, "sort");
        assertTrue(sortMap.containsKey("loanFolderId"));
        assertEquals(Sort.Direction.ASC, sortMap.get("loanFolderId"));

        verifyNoInteractions(repository);
    }

    @Test
    public void constructor_should_assign_repository_correctly() throws Exception {
        BillingSpaceJpaRepository mockRepo = mock(BillingSpaceJpaRepository.class);
        BillingSpaceSynchroItemReader customReader = new BillingSpaceSynchroItemReader(mockRepo);

        Object repoValue = getAnyField(customReader, "repository");
        assertSame(mockRepo, repoValue);

        customReader.init();
        Object methodName = getAnyField(customReader, "methodName");
        assertEquals("findByBillingSpaceStatus", methodName);
        verifyNoInteractions(mockRepo);
    }

    @Test
    public void init_should_be_idempotent_when_called_twice() throws Exception {
        reader.init();
        reader.init();
        Object args = getAnyField(reader, "arguments");
        assertNotNull(args);
        verifyNoInteractions(repository);
    }

    /**
     * Recherche un champ dans la classe ou ses superclasses, même s’il est protected/private,
     * et le lit de manière sûre pour Java 17+ (pas d’accès illégal).
     */
    private Object getAnyField(Object instance, String name) throws Exception {
        Class<?> clazz = instance.getClass();
        while (clazz != null) {
            for (Field f : clazz.getDeclaredFields()) {
                if (f.getName().equals(name)) {
                    f.setAccessible(true);
                    return f.get(instance);
                }
            }
            clazz = clazz.getSuperclass();
        }
        throw new NoSuchFieldException("Champ introuvable : " + name);
    }
}