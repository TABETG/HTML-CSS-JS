package com.bnpparibas.dsibddf.ap00420.streamfact.batch.paymentrequestpaid.writer;

import com.bnpparibas.dsibddf.ap00420.streamfact.domain.engines.UpdatePaymentRequestResult;
import com.bnpparibas.dsibddf.ap00420.streamfact.domain.entity.billingspace.model.BillingSpace;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.billingspace.mapper.BillingSpaceMapperToJpa;
import com.bnpparibas.dsibddf.ap00420.streamfact.infrastructure.sql.entities.billingspace.repository.BillingSpaceJpaRepository;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.*;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.batch.item.Chunk;

import java.util.*;

import static org.junit.Assert.assertEquals;
import static org.mockito.Mockito.*;

/**
 * Classe de test 100% JUnit4 compatible Sonar/Jenkins.
 */
@RunWith(MockitoJUnitRunner.class)
public class BillingSpaceUpdatePaymentRequestItemWriterTest {

    @Mock
    private BillingSpaceJpaRepository billingSpaceRepositoryJpaRepository;

    @InjectMocks
    private BillingSpaceUpdatePaymentRequestItemWriter writer;

    @Before
    public void setUp() {
        // rien Ã  initialiser
    }

    @Test
    public void write_withEmptyChunk_shouldDoNothing() throws Exception {
        Chunk<UpdatePaymentRequestResult> emptyChunk = new Chunk<>(Collections.emptyList());

        writer.write(emptyChunk);

        verifyNoInteractions(billingSpaceRepositoryJpaRepository);
    }

    @Test
    public void write_withNonEmptyChunk_shouldMapAndSaveAll() throws Exception {
        // Mocks
        UpdatePaymentRequestResult item = mock(UpdatePaymentRequestResult.class);
        BillingSpace billingSpace = mock(BillingSpace.class);

        when(item.getPaymentRequestPaidList()).thenReturn(Collections.emptyList());
        when(item.getPaymentRequestRefusedList()).thenReturn(Collections.emptyList());
        when(item.getBillingSpace()).thenReturn(billingSpace);

        Object mappedJpaEntity = new Object();

        try (MockedStatic<BillingSpaceMapperToJpa> mocked = Mockito.mockStatic(BillingSpaceMapperToJpa.class)) {
            mocked.when(() -> BillingSpaceMapperToJpa.toJpa(billingSpace)).thenReturn(mappedJpaEntity);

            Chunk<UpdatePaymentRequestResult> chunk = new Chunk<>(Collections.singletonList(item));
            writer.write(chunk);

            @SuppressWarnings("rawtypes")
            ArgumentCaptor<List> captor = ArgumentCaptor.forClass(List.class);
            verify(billingSpaceRepositoryJpaRepository, times(1)).saveAll(captor.capture());

            List<?> savedList = captor.getValue();
            assertEquals(1, savedList.size());
            assertEquals(mappedJpaEntity, savedList.get(0));

            verify(item, atLeastOnce()).getPaymentRequestPaidList();
            verify(item, atLeastOnce()).getPaymentRequestRefusedList();
            verify(item, atLeastOnce()).getBillingSpace();

            verifyNoMoreInteractions(billingSpaceRepositoryJpaRepository);
        }
    }
}