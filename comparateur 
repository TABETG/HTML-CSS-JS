import difflib
import os
import webbrowser

# --- CONFIGURATION DES CHEMINS ---
# L'astuce est le 'r' devant les guillemets pour gérer les backslashes Windows
# J'ai corrigé les fautes de frappe probables (FastAPI, .txt, etc.)

fichier_1 = r"C:\Users\btabet_consultant\PycharmProjects\FastAPIProject\Travail_Construction\PythonExtract\PythonExtract.txt"
fichier_2 = r"C:\Users\btabet_consultant\PycharmProjects\FastAPIProject\Travail_Construction\ClearCaseExtract\ClearCaseExtract.txt"

fichier_sortie = "resultat_comparaison.html"

def comparer_fichiers(f1_path, f2_path, out_path):
    print("--- Vérification des fichiers ---")

    # 1. Vérification stricte des chemins
    if not os.path.exists(f1_path):
        print(f"❌ ERREUR FATALE : Le fichier 1 est introuvable à cet endroit :")
        print(f"   -> {f1_path}")
        print("   Vérifiez le nom du dossier (ex: espaces vs underscores) ou l'extension .txt")
        return

    if not os.path.exists(f2_path):
        print(f"❌ ERREUR FATALE : Le fichier 2 est introuvable à cet endroit :")
        print(f"   -> {f2_path}")
        return

    print("✅ Les deux fichiers ont été trouvés. Comparaison en cours...")

    try:
        # 2. Lecture (encodage utf-8 ou latin-1 selon ton système)
        # Si ça plante ici, change 'utf-8' par 'latin-1'
        with open(f1_path, 'r', encoding='utf-8', errors='ignore') as f1:
            lignes_f1 = f1.readlines()
        
        with open(f2_path, 'r', encoding='utf-8', errors='ignore') as f2:
            lignes_f2 = f2.readlines()

        # 3. Création du HTML (Style Notepad++)
        diff = difflib.HtmlDiff(wrapcolumn=90)
        html_content = diff.make_file(lignes_f1, lignes_f2, fromdesc="Python Extract", todesc="ClearCase Extract")

        # 4. Sauvegarde
        with open(out_path, 'w', encoding='utf-8') as f_out:
            f_out.write(html_content)
        
        print(f"✅ Terminé ! Rapport généré : {os.path.abspath(out_path)}")
        
        # 5. Ouverture automatique dans le navigateur
        webbrowser.open('file://' + os.path.abspath(out_path))

    except Exception as e:
        print(f"❌ Une erreur inattendue est survenue : {e}")

if __name__ == "__main__":
    comparer_fichiers(fichier_1, fichier_2, fichier_sortie)
